{% extends 'main/base.html' %}
{% load static %}
{% block title %}
{{ title }}
{% endblock %}

{% block content %}
<div class="modal fade" id="modal-main" tabindex="-1" aria-labelledby="modal-main-label" aria-hidden="true">
    <div class="modal-dialog">
        <div id="hx-modal-main">
        </div>
    </div>
</div>
<div class="collapse mt-3" id="collapseCarrierStats">
    <div class="d-flex flex-wrap gap-4 justify-content-center">
        <div style="width: 500px; height: 500px;">
            <canvas id="weightPieChart"></canvas>
        </div>
        <div style="width: 500px; height: 500px;">
            <canvas id="volumePieChart"></canvas>
        </div>
    </div>
    <div class="d-flex flex-wrap gap-4 justify-content-center">
        <div class="w-100">
    <canvas id="carrierStackedWeightChart" height="100"></canvas>
</div>
<div class="w-100">
    <canvas id="carrierStackedVolumeChart" height="100"></canvas>
</div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="{% static 'main/js/chartjs-plugin-datalabels@2.js' %}"></script>
<!--<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2"></script>-->






<div class="container-fluid">
    {% if user.role == 'Логист' or user.role == 'Супер Администратор' or user.role == 'РОП' or user.role == 'Менеджер' %}
    <div class="col-auto mb-2">
        <button class="btn btn-primary"
                data-bs-toggle="collapse"
                data-bs-target="#collapseCarrierStats"
                aria-expanded="false"
                aria-controls="collapseCarrierStats">
            График по перевозчикам
        </button>
    </div>
    {% endif %}
    {% if user.role == 'Логист' or user.role == 'Супер Администратор' %}
    {% include "analytics/components/modal/modalInputCarrierFile.html"  %}
    {% include "analytics/components/modal/modalEditArticleForLogist.html"  %}
    {% include "analytics/components/modal/modalDeleteArticleForLogist.html"  %}
    {% include "analytics/logistic_main/modal/modalAddCargo.html"  %}
    <div class="row g-2 justify-content-start">
        <div class="col-auto">
            <button type="button" class="btn btn-sm btn-success"
                    data-bs-toggle="modal" data-bs-target="#modalInputCarrierFile">
                <i class="fa-solid fa-cloud-arrow-down"></i>
                Загрузить файл перевозчика
            </button>
        </div>
        <div class="col-auto">
            <button type="button" class="btn btn-sm btn-success"
                    data-bs-toggle="modal" data-bs-target="#modalAddCargo">
                <i class="fa-solid fa-cloud-arrow-down"></i>
                Добавить вручную
            </button>
        </div>
        <!--        <div class="col-auto">-->
        <!--            <button type="button" class="btn btn-sm btn-dark">-->
        <!--                <i class="fa-solid fa-file-export"></i>-->
        <!--                Выгрузка отчета по грузам-->
        <!--            </button>-->
        <!--        </div>-->
        <!--        <div class="col-auto">-->

        <!--            <button class="btn btn-sm btn-primary" type="button"-->
        <!--                    data-bs-toggle="collapse" data-bs-target="#collapseWithoutInsuranceArticles"-->
        <!--                    aria-expanded="false" aria-controls="collapseWithoutInsuranceArticles" >-->
        <!--                <i class="fa-solid fa-car-burst"></i>-->
        <!--                Груза без страховки: {{ count_articles_without_insurance }}-->
        <!--            </button>-->
        <!--        </div>-->
        <div class="col-auto">

            <button class="btn btn-sm btn-danger" type="button"
                    data-bs-toggle="collapse" data-bs-target="#collapseNotIssuedArticles"
                    aria-expanded="false" aria-controls="collapseNotIssuedArticles" >
                <i class="fa-solid fa-house-lock"></i>
                Не выданные: {{ count_all_articles_not_issued }}
            </button>
        </div>
        <div class="col-auto">
            <button class="btn btn-sm btn-secondary" type="button"
                    data-bs-toggle="collapse" data-bs-target="#multiCollapseResponsibleManager"
                    aria-expanded="false" aria-controls="multiCollapseResponsibleManager">
                <i class="fa-solid fa-users-slash"></i>
                С пустым менеджером: {{ count_empty_responsible_manager }}
            </button>
        </div>
        <div class="col-auto">
            <button class="btn btn-sm btn-secondary" type="button"
                    data-bs-toggle="collapse" data-bs-target="#multiCollapsePathFormat"
                    aria-expanded="false" aria-controls="multiCollapsePathFormat">
                <i class="fa-solid fa-road-circle-xmark"></i>
                С пустой дорогой: {{ count_empty_path_format }}
            </button>
        </div>
        <!--        <div class="col-auto">-->
        <!--            <button type="button" class="btn btn-sm text-primary-emphasis bg-primary-subtle border border-primary-subtle"-->
        <!--                    data-bs-toggle="modal" data-bs-target="#modal-main"-->
        <!--                    hx-get="{% url 'analytics:amount_fund' %}" hx-target="#hx-modal-main">-->
        <!--                <i class="fa-solid fa-money-bill-trend-up"></i>-->
        <!--                Сумма фонда-->
        <!--            </button>-->
        <!--        </div>-->
    </div>
    {% include "analytics/components/collapse/collapseNotIssuedArticles.html"  %}
    {% include "analytics/components/collapse/collapseWithoutInsuranceArticles.html"  %}
    {% include "analytics/components/collapse/collapseEmptyPathAndResponsibleManager.html"  %}
    {% include "analytics/components/messagesError.html"  %}
    {% endif %}
    {% include "analytics/logistic_main/filters.html"  %}

    <div id="hx-table">
        {% include "analytics/logistic_main/table.html"  %}
    </div>
</div>
<script>
const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]')
const tooltipList = [...tooltipTriggerList].map(tooltipTriggerEl => new bootstrap.Tooltip(tooltipTriggerEl))
let maskOptions = {
        mask: Number,
        padFractionalZeros: false,  // if true, then pads zeros at end to the length of scale
        normalizeZeros: true,  // appends or removes zeros at ends
        radix: ',',  // fractional delimiter
        mapToRadix: ['.'],
        min: 0,
        max: 10000000000,
        thousandsSeparator: ' '
};
var myModal = document.getElementById('edit')
myModal.addEventListener('shown.bs.modal', function () {
  let element = document.querySelectorAll('input[id="id_prr"]');
for (let i = 0; i < element.length; i++){
        let mask = IMask(element[i], maskOptions);
}
let element2 = document.querySelectorAll('input[id="id_tat_cost"]');
for (let i = 0; i < element2.length; i++){
        let mask = IMask(element2[i], maskOptions);
}
})
document.body.addEventListener('htmx:configRequest', (event) => {
    event.detail.headers['X-CSRFToken'] = '{{ csrf_token }}'
});

function integer_mask(MyName){
let element = document.querySelectorAll('.'+MyName+'');
var integer_options = {
    mask: Number,
    padFractionalZeros: false,
    normalizeZeros: true,
    radix: ',',
    mapToRadix: ['.'],
    scale: 3,
    min: 0,
    max: 10000000,
    thousandsSeparator: '',
};
for (let i = 0; i < element.length; i++){
        let mask = IMask(element[i], integer_options);
    }
}
integer_mask("imask_float");
</script>
<script>
Chart.register(ChartDataLabels);

const renderTotalLabels = {
    id: 'renderTotalLabels',
    afterDatasetsDraw(chart) {
    const { ctx, chartArea, data, scales } = chart;
    if (!scales?.x || !scales?.y) return;

    const { x } = scales;

    ctx.save();
    data.labels.forEach((month, i) => {
        let sum = 0;
        let count = 0;
        data.datasets.forEach(ds => {
            if (!ds.hidden && typeof ds.data[i] === 'number') {
                sum += ds.data[i];
                if (ds.counts) count += ds.counts[i] || 0;
            }
        });

        const xPos = x.getPixelForValue(i);
        const yPos = chartArea.top + 2;

        if (sum > 0) {
            ctx.font = 'bold 13px sans-serif';
            ctx.fillStyle = '#222';
            ctx.textAlign = 'center';
            ctx.fillText(`${sum.toLocaleString()} / ${count} шт.`, xPos, yPos);
        }
    });
    ctx.restore();
}

};



Chart.register(renderTotalLabels); // ← теперь правильно



let weightChartInstance = null;
let volumeChartInstance = null;

function renderCharts() {
    function getColor(seed) {
        const hash = [...seed].reduce((a, c) => a + c.charCodeAt(0), 0);
        const r = (hash * 123) % 255;
        const g = (hash * 321) % 255;
        const b = (hash * 213) % 255;
        return `rgba(${r}, ${g}, ${b}, 0.7)`;
    }
    const data = {{ carrier_chart_data|safe }};
    const labels = data.map(item => item.carrier);
    const weightValues = data.map(item => Math.round(item.total_weight || 0));
    const volumeValues = data.map(item => Math.round(item.total_volume || 0));
    const totalWeight = weightValues.reduce((a, b) => a + b, 0);
    const totalVolume = volumeValues.reduce((a, b) => a + b, 0);
    const colors = labels.map(getColor);

    const ctxWeight = document.getElementById('weightPieChart');
    const ctxVolume = document.getElementById('volumePieChart');

    if (weightChartInstance) weightChartInstance.destroy();
    if (volumeChartInstance) volumeChartInstance.destroy();

    weightChartInstance = new Chart(ctxWeight, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: 'Вес (кг)',
                data: weightValues,
                backgroundColor: colors
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: {
                    display: true,
                    text: `Распределение веса по перевозчикам (всего ${totalWeight.toLocaleString()} кг)`
                },
                datalabels: {
                    color: '#000',
                    font: { weight: 'bold' },
                    formatter: (value, context) => {
    const count = data[context.dataIndex]?.total_articles || 0;
    const percent = (value / totalWeight) * 100;
    return `${percent.toFixed(1)}% (${count})`;
}
                }
            }
        },
        plugins: [ChartDataLabels]
    });

    volumeChartInstance = new Chart(ctxVolume, {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: 'Объем (м³)',
                data: volumeValues,
                backgroundColor: colors
            }]
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: {
                    display: true,
                    text: `Распределение объема по перевозчикам (всего ${totalVolume.toLocaleString()} м³)`
                },
                datalabels: {
                    color: '#000',
                    font: { weight: 'bold' },
                    formatter: (value, context) => {
    const count = data[context.dataIndex]?.total_articles || 0;
    const percent = (value / totalVolume) * 100;
    return `${percent.toFixed(1)}% (${count})`;
}

                }
            }
        },
        plugins: [ChartDataLabels]
    });



    const stackedData = {{ carrier_stacked_data|safe }};
    const months = Object.keys(stackedData);
    const stackedCarriers = [...new Set(Object.values(stackedData).flatMap(m => Object.keys(m)))];

    const getStackedDataset = (field) => {
    return stackedCarriers.map(carrier => {
        const values = months.map(month => stackedData[month][carrier]?.[field] || 0);
        const counts = months.map(month => stackedData[month][carrier]?.count || 0);
        return {
            label: carrier,
            data: values,
            counts: counts,  // <- вот это для рендера
            backgroundColor: getColor(carrier)
        };
    });
};
    const getMonthTotals = (field) => {
    return months.map(month =>
        stackedCarriers.reduce((sum, carrier) => {
            return sum + (stackedData[month][carrier]?.[field] || 0);
        }, 0)
    );
};

    const stackedWeightChart = new Chart(document.getElementById('carrierStackedWeightChart'), {
        type: 'bar',
        data: {
            labels: months,
            datasets: getStackedDataset('weight')
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Вес по месяцам (stacked)' },
                datalabels: {
    // Встроенные метки на каждом блоке
    color: '#222',
    anchor: 'center',
    align: 'center',
    offset: 1,
    font: {
        weight: 'bold',
        size: 11
    },
    formatter: (value, context) => {
    const datasetLabel = context.dataset.label;
    const monthLabel = context.chart.data.labels[context.dataIndex];
    const articles = stackedData[monthLabel]?.[datasetLabel]?.count || 0;

    return value > 50 ? `${Math.round(value).toLocaleString()} (${articles} шт.)` : '';
},
    clamp: true,
    display: 'true'
}



            },
            scales: {
                x: { stacked: true },
                y: {
                    stacked: true,
                    title: { display: true, text: 'Вес (кг)' }
                }
            }
        },
        plugins: [ChartDataLabels, renderTotalLabels]
    });

    const stackedVolumeChart = new Chart(document.getElementById('carrierStackedVolumeChart'), {
        type: 'bar',
        data: {
            labels: months,
            datasets: getStackedDataset('volume')
        },
        options: {
            responsive: true,
            plugins: {
                legend: { position: 'top' },
                title: { display: true, text: 'Объем по месяцам (stacked)' },
                datalabels: {
    color: '#222',
    anchor: 'center',
    align: 'center',
    offset: 1,
    font: {
        weight: 'bold',
        size: 11
    },
    formatter: (value, context) => {
    const datasetLabel = context.dataset.label;
    const monthLabel = context.chart.data.labels[context.dataIndex];
    const articles = stackedData[monthLabel]?.[datasetLabel]?.count || 0;

    return value > 0 ? `${Math.round(value).toLocaleString()} (${articles} шт.)` : '';
}
,
    clamp: true,
    display: 'true'  // отключает отображение, если не влезает
}


            },
            scales: {
                x: { stacked: true },
                y: {
                    stacked: true,
                    title: { display: true, text: 'Объем (м³)' }
                }
            }
        },
        plugins: [ChartDataLabels, renderTotalLabels]
    });

}



// Запуск отрисовки при открытии блока
document.getElementById('collapseCarrierStats').addEventListener('shown.bs.collapse', renderCharts);


</script>
{% endblock %}