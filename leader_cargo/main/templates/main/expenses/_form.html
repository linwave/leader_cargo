{# templates/main/expenses/_form.html #}
<form id="expense-form"
      hx-post="{{ action_url }}"
      hx-target="#expenses-table"
      hx-swap="innerHTML"
      hx-include="#filter-form"
      enctype="multipart/form-data">

  {% csrf_token %}
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title">{{ title }}</h5>
      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
    </div>

    <div class="modal-body">
      <div class="row g-3">
        <div class="col-md-4">
          <label class="form-label">–î–∞—Ç–∞ –ø–ª–∞—Ç–µ–∂–∞</label>
          {{ form.date_payment }}
        </div>
        <div class="col-md-4">
          <label class="form-label">–ò—Å—Ç–æ—á–Ω–∏–∫</label>
          {{ form.source }}
        </div>
        <div class="col-md-4">
          <label class="form-label">–°—É–º–º–∞, ‚ÇΩ</label>
          {{ form.amount }}
        </div>
        <div class="col-12">
          <label class="form-label">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          {{ form.comment }}
        </div>

        <div class="col-12">
          <label class="form-label d-block">–§–∞–π–ª –ø–ª–∞—Ç–µ–∂–∫–∏</label>

          {# –∫—Ä–∞—Å–∏–≤—ã–π dnd/paste –±–ª–æ–∫ #}
          <div id="drop-zone"
               class="border border-2 border-dashed rounded p-4 text-center"
               style="border-style:dashed; cursor:pointer; outline:0;"
               tabindex="0">
            <div id="dz-empty">
              –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞, –∫–ª–∏–∫–Ω–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞
              <div class="small text-muted mt-1">–∏–ª–∏ Ctrl/‚åò+V ‚Äî –≤—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞</div>
            </div>
            <div id="dz-file" class="d-none">
              <span class="me-2">üìé <span id="dz-file-name"></span></span>
              <button type="button" class="btn btn-sm btn-outline-secondary" id="dz-change-btn">–ó–∞–º–µ–Ω–∏—Ç—å</button>
              <button type="button" class="btn btn-sm btn-outline-danger" id="dz-clear-btn">–£–±—Ä–∞—Ç—å</button>
            </div>
          </div>

          <input type="file" name="receipt_file" id="receipt-input" class="d-none">
          <input type="hidden" name="receipt_file-clear" id="receipt-clear-flag" value="">


          {% if existing_file %}
          <div class="mt-2">
            –¢–µ–∫—É—â–∏–π —Ñ–∞–π–ª:
            <a href="{{ existing_file.url }}" target="_blank" rel="noopener noreferrer">
              üìé {{ existing_file.name|slice:"-40:" }}
            </a>
          </div>
          {% endif %}
        </div>
      </div>
    </div>

    <div class="modal-footer">
      <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
      <button type="submit" class="btn btn-primary btn-sm" id="save-btn">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    </div>
  </div>
</form>

<script>
(function(){
  // –±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –¥–≤–æ–π–Ω–æ–≥–æ –∫–ª–∏–∫–∞ –ø–æ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
  const form = document.getElementById('expense-form');
  const saveBtn = document.getElementById('save-btn');

  form.addEventListener('submit', ()=> {
    if (saveBtn){ saveBtn.disabled = true; saveBtn.innerText='–°–æ—Ö—Ä–∞–Ω—è—é...'; }

    // –¥–æ–±–∞–≤–∏–º —Ç–µ–∫—É—â–∏–µ query –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∫ —Ñ–æ—Ä–º–µ –±–µ–∑ hx-vals="js:..."
    const qs = new URLSearchParams(window.location.search);
    qs.forEach((v, k) => {
      if (!form.querySelector(`[name="${k}"]`)) {
        const input = document.createElement('input');
        input.type = 'hidden'; input.name = k; input.value = v;
        form.appendChild(input);
      }
    });
  });

  function resetBtn(){ if(saveBtn){ saveBtn.disabled = false; saveBtn.innerText='–°–æ—Ö—Ä–∞–Ω–∏—Ç—å'; } }
  document.body.addEventListener('htmx:sendError', resetBtn);
  document.body.addEventListener('htmx:responseError', resetBtn);

  // —ç–ª–µ–º–µ–Ω—Ç—ã —Ñ–∞–π–ª–æ–≤–æ–≥–æ UI
  const input = document.getElementById('receipt-input');
  const dz = document.getElementById('drop-zone');
  const dzEmpty = document.getElementById('dz-empty');
  const dzFile = document.getElementById('dz-file');
  const dzName = document.getElementById('dz-file-name');
  const dzChange = document.getElementById('dz-change-btn');
  const dzClear = document.getElementById('dz-clear-btn');
  const clearFlag = document.getElementById('receipt-clear-flag');

  // –∫—Ä–∞—Å–∏–≤—ã–π —Ñ–æ–∫—É—Å –Ω–∞ dnd-–∑–æ–Ω–µ: —Å—Ä–∞–∑—É –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º, —á—Ç–æ–±—ã paste —Ä–∞–±–æ—Ç–∞–ª "—Å—Ö–æ–¥—É"
  setTimeout(()=> dz && dz.focus(), 50);

  function showFile(f){
    if (!f) return;
    clearFlag.value = ''; // –≤—ã–±–∏—Ä–∞–µ–º –Ω–æ–≤—ã–π ‚Äî –Ω–µ —á–∏—Å—Ç–∏–º —Å—Ç–∞—Ä—ã–π
    dzEmpty.classList.add('d-none');
    dzFile.classList.remove('d-none');
    dzName.textContent = f.name || '—Ñ–∞–π–ª';
  }
  function clearFile(){
    input.value = "";
    clearFlag.value = '1'; // –ø–æ–º–µ—á–∞–µ–º –æ—á–∏—Å—Ç–∫—É —Å—Ç–∞—Ä–æ–≥–æ
    dzFile.classList.add('d-none');
    dzEmpty.classList.remove('d-none');
  }

  // –∫–ª–∏–∫–∏ / dnd
  dz.addEventListener('click', (e)=>{
    if (e.target.closest('a,button,label')) return;
    input.click();
  });
  dzChange.addEventListener('click', ()=> input.click());
  dzClear.addEventListener('click', clearFile);
  dz.addEventListener('dragover', e=>{ e.preventDefault(); dz.classList.add('bg-light'); });
  dz.addEventListener('dragleave', ()=> dz.classList.remove('bg-light'));
  dz.addEventListener('drop', e=>{
    e.preventDefault(); dz.classList.remove('bg-light');
    if (e.dataTransfer.files && e.dataTransfer.files[0]){
      input.files = e.dataTransfer.files;
      showFile(input.files[0]);
    }
  });
  input.addEventListener('change', ()=>{
    if (input.files && input.files[0]) showFile(input.files[0]); else clearFile();
  });

  // PASTE –ø–æ –≤—Å–µ–π –º–æ–¥–∞–ª–∫–µ (–Ω–æ –Ω–µ –∫–æ–≥–¥–∞ –∫—É—Ä—Å–æ—Ä –≤ input/textarea)
  function onPaste(e){
    const t = e.target;
    if (t && (t.tagName === 'INPUT' || t.tagName === 'TEXTAREA' || t.isContentEditable)) return;

    let file = null;

    // 1) items (—Å–∫—Ä–∏–Ω—à–æ—Ç –∏–∑ –±—É—Ñ–µ—Ä–∞ —á–∞—â–µ —Ç—É—Ç)
    const items = e.clipboardData && e.clipboardData.items;
    if (items && items.length){
      for (let i=0;i<items.length;i++){
        if (items[i].kind === 'file'){
          file = items[i].getAsFile();
          break;
        }
      }
    }
    // 2) files (–∏–Ω–æ–≥–¥–∞ —Ç–æ–ª—å–∫–æ —Ç—É—Ç)
    if (!file){
      const files = e.clipboardData && e.clipboardData.files;
      if (files && files.length) file = files[0];
    }

    if (file){
      const dt = new DataTransfer();
      dt.items.add(file);
      input.files = dt.files;
      showFile(file);
    }
  }

  // –≤–µ—à–∞–µ–º/—Å–Ω–∏–º–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ paste –Ω–∞ –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ –º–æ–¥–∞–ª–∫–∏
  document.addEventListener('paste', onPaste, true);
  const modalEl = document.getElementById('hx-modal');
  modalEl && modalEl.addEventListener('hidden.bs.modal', ()=> {
    document.removeEventListener('paste', onPaste, true);
  }, { once:true });
})();
</script>


