{% load custom_filters %}
<div id="leads-chart-data" hx-swap-oob="innerHTML" style="display:none">
    {{ managers_with_calls|safe }}
</div>


<input type="hidden" id="total-pages" value="{{ paginated_queryset.paginator.num_pages }}">
<div class="container-fluid">
    <div class="row mb-2">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <div class="small text-muted">
                Показано: <span class="fw-semibold">{{ page_current }}</span>
                из <span class="fw-semibold">{{ filtered_total }}</span> найденных лидов
            </div>
            <span class="badge text-bg-secondary">{{ page_current }} / {{ filtered_total }}</span>
        </div>
    </div>
    <div class="row">
        <div class="col-12">
            <div class="table-responsive" style="border: 1px solid #000;
            overflow-y: auto;overflow-x: auto;height: 72vh;">
                <table class="table align-middle  table-hover g-1"
                       style="font-size: 0.8rem;">
                    <thead class="table-dark " style="position: sticky;top: 0;left: 0;z-index: 10;">
                    <tr style="vertical-align: middle;">
                        <th width="10" scope="col">#</th>
                        <th scope="col">Менеджер</th>
                        <th scope="col">CRM</th>
                        <th scope="col">Статус</th>
                        <th scope="col">Имя клиента</th>
                        <th scope="col">Контактный номер</th>
                        <th scope="col">Город клиента</th>
                        <th scope="col">Лояльность</th>
                        <th scope="col">Комментарий по звонку от оператора</th>
                        <th scope="col">Комментарий по звонку</th>
                        <th scope="col">Дата следующего звонка</th>
                        <th scope="col">Дата передачи менеджеру</th>
                        {% if user.role == 'Супер Администратор' or  user.role == 'РОП' %}
                        <th scope="col">Дата взятия В работу</th>
                        <th scope="col">Дата Утверждения/Отказа/Другое</th>
                        {% endif %}
                    </tr>
                    </thead>
                    <tbody class="table-light">
                    {% for lead in paginated_queryset %}
                    <tr data-bs-toggle="modal"
                        data-bs-target="#hx-modal"
                        hx-get="{% url 'main:edit_leads' lead.pk %}"
                        hx-target="#hx-modal-body"
                        id="lead_{{ lead.id }}"
                        style="cursor: pointer;">
                        <th scope="row">{{ lead.pk }} - ({{ lead.call.pk }})</th>
                        <td>{{ lead.manager|default:"" }}</td>
                        <td>
                            {% if lead.call %}
                            {% if lead.call.crm %}
                            {{ lead.call.crm }}
                            {% elif lead.call.call_file and lead.call.call_file.crm %}
                            {{ lead.call.call_file.get_crm_display }}
                            {% endif %}
                            {% endif %}
                        </td>
                        <td>{{ lead.status_manager|default:"" }}</td>
                        <td>{{ lead.client_name|default:"" }}</td>
                        <td>{{ lead.client_phone|default:"" }}</td>
                        <td>{{ lead.client_location|default:"" }}</td>
                        <td>{{ lead.get_loyalty_display|default:"" }}</td>
                        <td>{{ lead.call.description|default:"" }}</td>
                        <td>{{ lead.description_manager|default:"" }}</td>
                        <td>{{ lead.date_next_call_manager|default:"" }}</td>
                        <td>{{ lead.time_new|default:"" }}</td>
                        {% if user.role == 'Супер Администратор' or  user.role == 'РОП' %}
                        <td>{{ lead.time_in_work|default:"" }}</td>
                        <td>{{ lead.time_approve_no_other|default:"" }}</td>
                        {% endif %}
                    </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
<!-- Пагинация -->
{% if paginated_queryset.paginator.num_pages != 1 %}
<div class="pagination">
        <span class="page-links">
            {% if paginated_queryset.has_previous %}
                <a href="?page=1&{{ request.GET|urlencode_after_remove:'page' }}" class="page-link">&laquo; 1</a>
                <a href="?page={{ paginated_queryset.previous_page_number }}&{{ request.GET|urlencode_after_remove:'page' }}" class="page-link"><</a>
            {% endif %}
            {% for i in page_range_ %}
                {% if paginated_queryset.number == i %}
                    <span class="current-page page-link">{{ i }}</span>
                {% else %}
                    <a href="?page={{ i }}&{{ request.GET|urlencode_after_remove:'page' }}" class="page-link">{{ i }}</a>
                {% endif %}
            {% endfor %}
            {% if paginated_queryset.has_next %}
                <a href="?page={{ paginated_queryset.next_page_number }}&{{ request.GET|urlencode_after_remove:'page' }}" class="page-link">></a>
                <a href="?page={{ paginated_queryset.paginator.num_pages }}&{{ request.GET|urlencode_after_remove:'page' }}" class="page-link">{{ paginated_queryset.paginator.num_pages }} &raquo;</a>
            {% endif %}
            <input type="number" id="pageInput" min="1" max="{{ paginated_queryset.paginator.num_pages }}" value="{{ paginated_queryset.number }}" class="form-control form-control-sm d-inline-block p-2" style="width: 65px;">
            <button id="goToPage" class="btn btn-sm btn-primary">Перейти</button>
        </span>
</div>
{% endif %}